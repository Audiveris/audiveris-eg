<?xml version="1.0" encoding="utf-8"?>

<!-- ======================================================================= -->
<!--                                                                         -->
<!--                        a u d i v e r i s . w x s                        -->
<!--                                                                         -->
<!-- ======================================================================= -->

<!--
Personal rules:
- Variables start with "my" and are defined in -windows.xml
- Ids start with a lowercase letter and end with "Id"
- Component Ids end with ".CID"

Assumption: myArch is set to either x64 or x86
-->

<?if $(var.myArch)=x64 ?>

<!-- This Product GUID must be changed for each release shipped -->
<?define myProductId  = "f5441af8-8701-4cee-8c66-cf66b1ffc147" ?>
<?define mySystemRef  = "System64Folder" ?>
<?define myProgramRef = "ProgramFiles64Folder" ?>
<?define myFullDll    = "$(var.myDll)\x64" ?>
<?define myVC         = "$(var.myMsmDir)\Microsoft_VC90_CRT_x86_x64.msm" ?>
<?define myGsDll      = "gsdll64.dll" ?>
<?define myGsExe      = "gswin64c.exe" ?>

<?else ?>

<!-- This Product GUID must be changed for each release shipped -->
<?define myProductId  = "08ea756a-712f-42d7-9d7e-a9188bb74e4e" ?>
<?define mySystemRef  = "SystemFolder" ?>
<?define myProgramRef = "ProgramFilesFolder" ?>
<?define myFullDll    = "$(var.myDll)\x86" ?>
<?define myVC         = "$(var.myMsmDir)\Microsoft_VC90_CRT_x86.msm" ?>
<?define myGsDll      = "gsdll32.dll" ?>
<?define myGsExe      = "gswin32c.exe" ?>

<?endif ?>

<!-- This Upgrade GUID is to allow major upgrades. Never change this GUID -->
<?define myUpgradeCode = "93f5ea46-0cc0-48c9-9836-a06313db7169" ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  
    <Product Id="$(var.myProductId)" 
             UpgradeCode="$(var.myUpgradeCode)" 
             Name="$(var.myProductName) $(var.myImplVersion) ($(var.myArch))"
             Language="1033" 
             Codepage="1252" 
             Version="$(var.myImplVersion)" 
             Manufacturer="$(var.myCompany)">
    
        <Package Id="*"
                 Keywords="Installer"
                 Description="$(var.myCompany)'s $(var.myProductName) Installer"
                 Manufacturer="$(var.myCompany)"
                 InstallerVersion="300"
                 Languages="1033"
                 Compressed="yes"
                 SummaryCodepage="1252" />
    
        <!-- Support for major upgrades -->
        <!-- Prevent downgrades         -->
        <MajorUpgrade
            DowngradeErrorMessage="A later version of $(var.myProductName) is already installed. Setup will now exit."/>
    
        <Media Id="1" Cabinet="Sample.cab" EmbedCab="yes" />
    
        <!-- List of directories used by this product.              -->
        <!-- This defines all folders referenced later in this file -->
        <Directory Id="TARGETDIR" Name="SourceDir">
      
            <!-- Program install directory -->
            <Directory Id="$(var.myProgramRef)">
                <Directory Id="manufacturerDirId" Name="$(var.myCompanyId)">
                    <Directory Id="INSTALLDIR" Name="$(var.myProductName)"/>
                </Directory>
            </Directory>
      
            <!-- System for DLLs  -->
            <Directory Id="$(var.mySystemRef)"/>
      
            <!-- Program Menu -->
            <Directory Id="ProgramMenuFolder">
                <Directory Id="programMenuDirId" Name="$(var.myProductName)">
                    <Component Id="programMenu.CID" Guid="70585908-a861-460e-b672-348861589ceb">
                        <RemoveFolder Id="programMenuDirId" On="uninstall" />
                        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                                       Name="application" Type="string" Value="installed" KeyPath="yes" />
                    </Component>
                </Directory>
            </Directory>
      
            <!-- Application data -->            
            <Directory Id="AppDataFolder">
                <Directory Id="adManufacturerDirId" Name="$(var.myCompanyId)">
                    <Directory Id="adProductDirId" Name="$(var.myProductName)" />
                </Directory>
            </Directory>
        
            <!-- Desktop -->
            <Directory Id="DesktopFolder" Name="Desktop" />
        
            <!-- MusicalSymbols font (permanent) -->
            <Directory Id="FontsFolder">
                <Component Id="fonts.CID" Guid="7ef37a03-35f7-4759-89d7-7ee047a9c737" Permanent="yes">
                    <File Id="musicalSymbolsId" Source="$(var.myMaterial)/MusicalSymbols.ttf" TrueType="yes" />
                </Component>
            </Directory>
        
        </Directory>
    
        <!-- ======= -->
        <!-- Program -->
        <!-- ======= -->
        <DirectoryRef Id="INSTALLDIR">
            <!-- Add the 64-bit registry component to the 64-bit MSI, and -->
            <!-- add the 32-bit registry component to the 32-bit MSI.     -->
      
            <!-- audiveris.exe & .ini-->
            <Component Id="mainExec.CID" Guid="6c534d31-29ff-4d78-a107-bf0ab542fb7e">
                <File Id="exeId" Name="$(var.mySoftware).exe" DiskId="1" Source="$(var.mySoftware).exe" KeyPath="yes">
                    <Shortcut Id="startmenuExeId" Directory="programMenuDirId" Name="$(var.mySoftware) application" 
                              WorkingDirectory="INSTALLDIR" Icon="myIcon.exe" IconIndex="0" Advertise="yes" />
                    <Shortcut Id="desktopExeId" Directory="DesktopFolder" Name="$(var.myProductName)" 
                              WorkingDirectory="INSTALLDIR" Icon="myIcon.exe" IconIndex="0" Advertise="yes" />
                </File>
                <File Id="exeIniId" Name="audiveris.l4j.ini" DiskId="1" Source="audiveris.l4j.ini"/>
        
            </Component>
      
            <!-- audiveris-console.exe & .ini -->
            <Component Id="mainConsole.CID" Guid="8d961fd4-caf9-4139-8093-71d90e826b0c">
                <File Id="consoleId" Name="$(var.myConsole).exe" DiskId="1" Source="$(var.myConsole).exe" />
                <File Id="consoleIniId" Name="audiveris-console.l4j.ini" DiskId="1" Source="audiveris-console.l4j.ini"/>
            </Component>
      
            <!-- audiveris.bat -->
            <Component Id="bat.CID" Guid="89e7a9f3-a224-4f14-8356-9dbabe93c2cc">
                <File Id="batId" Name="audiveris.bat" DiskId="1" Source="audiveris.bat"/>
            </Component>
      
            <!-- dist folder -->
            <Directory Id="distDirId" Name="dist">
                <Component Id="jar.CID" Guid="f4b1128a-a246-47dd-9a88-da2e1c8d1495">                            
                    <File Id="jarId" Name="audiveris.jar" DiskId="1" Source="$(var.myJar)" />
                </Component>
                <!-- lib (in separate gen-common-lib.wxs) -->
            </Directory>
            
            <!-- Ghostscript folder -->
            <Directory Id="gsDirId" Name="gs">
                <Directory Id="gsWindowsDirId" Name="windows">
                    <Directory Id="gsWindowsArchDirId" Name="$(var.myArch)">
                        <Component Id="gs.CID" Guid="5d20148c-4abb-4d76-835e-8bf0369dea0e">
                            <File Id="gs.dll" Name='$(var.myGsDll)' DiskId='1' Source='$(var.myGs)\$(var.myArch)\$(var.myGsDll)' />
                            <File Id="gs.exe" Name='$(var.myGsExe)' DiskId='1' Source='$(var.myGs)\$(var.myArch)\$(var.myGsExe)' />
                        </Component>
                    </Directory>                        
                </Directory>
            </Directory>
      
            <!-- ocr     (in separate gen-common-ocr.wxs) -->
            <!-- res     (in separate gen-common-res.wxs) -->                        
            <!-- www     (in separate gen-common-www.wxs) -->
        </DirectoryRef>            
    
        <!-- ====== -->
        <!-- System -->
        <!-- ====== -->
        <DirectoryRef Id="$(var.mySystemRef)">
            <!-- Bridge as non permanent -->
            <Component Id="bridge.CID" Guid="a66b5179-6a87-440f-b705-8eeda53a7a4c">
                <File Id='bridgeDLL'      Name='jniTessBridge.dll'          DiskId='1' Source='$(var.myFullDll)\jniTessBridge.dll' />
                <File Id='bridgeManifest' Name='jniTessBridge.dll.manifest' DiskId='1' Source='$(var.myFullDll)\jniTessBridge.dll.manifest' />
            </Component>
            <!-- Tesseract dll as permanent, in case other apps need it -->
            <Component Id="tesseract.CID" Guid="3900d10b-0ca1-46b9-9580-11efa47f8c9e" Permanent="yes">
                <File Id='tesseractDLL'   Name='libtesseract302.dll'        DiskId='1' Source='$(var.myFullDll)\libtesseract302.dll' />
            </Component>
            <!-- Leptonica dll as permanent, in case other apps need it -->
            <Component Id="leptonica.CID" Guid="e103c0fe-c43d-4a79-aa55-12971584a792" Permanent="yes">
                <File Id='leptonicaDLL'   Name='liblept168.dll'             DiskId='1' Source='$(var.myFullDll)\liblept168.dll' />
            </Component>
        </DirectoryRef>
    
        <!-- ================ -->            
        <!-- Application data -->            
        <!-- ================ -->            
        <DirectoryRef Id="adProductDirId">                        
            <Component Id="data.CID" Guid="640e0573-e200-437f-9196-0be336587ea5">                            
                <RemoveFolder Id='adProductDirId' Directory='adProductDirId' On='uninstall'/>
                <RemoveFolder Id='adManufacturerDirId' Directory='adManufacturerDirId' On='uninstall'/>
                <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                               Name="data" Type="string" Value="installed" KeyPath="yes" />
            </Component>
            
            <!-- Pre-populate settings folder with templates -->
            <Directory Id="settingsDirId" Name="settings">
                <!-- Handle the removal of settings directory -->
                <Component Id="settings.CID" Guid="727ca284-5993-4f56-b050-706ae6ff95ab">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                                   Name="settings" Type="string" Value="installed" KeyPath="yes" />
                    <RemoveFolder Id='settingsDirId' Directory='settingsDirId' On='uninstall'/>
                </Component>
                
                <!-- Template for settings/build.properties -->
                <Component Id="buildProperties.CID" Guid="13ac0e4e-fd3c-4dda-a8d8-021758c40de4">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]\settings" 
                                   Name="build.properties" Type="string" Value="installed" KeyPath="yes" />
                    <File Id="buildProperties" Name="build.properties" DiskId="1" Source="$(var.myTemplates)\build.properties" />
                </Component>
                
                <!-- Template for settings/logging.properties -->
                <Component Id="loggingProperties.CID" Guid="8e6e4be5-0f3f-42fd-b27f-0ec71c9cbc20">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]\settings" 
                                   Name="logging.properties" Type="string" Value="installed" KeyPath="yes" />
                    <File Id="loggingProperties" Name="logging.properties" DiskId="1" Source="$(var.myTemplates)\logging.properties" />
                </Component>
                
                <!-- Template for settings/user-actions.xml -->
                <Component Id="userActions.CID" Guid="d26b7dca-1521-489e-90d2-441ff2185323">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]\settings" 
                                   Name="user-actions.xml" Type="string" Value="installed" KeyPath="yes" />
                    <File Id="userActions" Name="user-actions.xml" DiskId="1" Source="$(var.myTemplates)\user-actions.xml" />
                </Component>
            </Directory>
      
            <!-- eval     (in separate gen-user-eval.wxs) -->
            <!-- examples (in separate gen-user-examples.wxs) -->
            <!-- plugins  (in separate gen-user-plugins.wxs) -->
            <!-- train    (in separate gen-user-train.wxs) -->
      
            <!-- benches empty folder -->
            <Directory Id="benchesDirId" Name="benches" >
                <Component Id="benches.CID" Guid="a7981cb8-3c22-4da4-a764-48803eb45458">                                
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                                   Name="benches" Type="string" Value="installed" KeyPath="yes" />
                    <CreateFolder />
                    <RemoveFolder Id="benchesDirId" On="uninstall" />                                
                </Component>
            </Directory>  
      
            <!-- print   empty folder -->
            <Directory Id="printDirId" Name="print" >
                <Component Id="print.CID" Guid="969331fb-1b9a-4df0-8952-67e184ee9006">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                                   Name="print" Type="string" Value="installed" KeyPath="yes" />
                    <CreateFolder />
                    <RemoveFolder Id="printDirId" On="uninstall" />                                
                </Component>
            </Directory>               
      
            <!-- scores  empty folder -->
            <Directory Id="scoresDirId" Name="scores" >
                <Component Id="scores.CID" Guid="4c458e06-4c2b-4b75-a2e3-c5a46b88a7c0">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                                   Name="scores" Type="string" Value="installed" KeyPath="yes" />
                    <CreateFolder />
                    <RemoveFolder Id="scoresDirId" On="uninstall" />                                
                </Component>
            </Directory>          
      
            <!-- scripts empty folder -->                        
            <Directory Id="scriptsDirId" Name="scripts" >
                <Component Id="scripts.CID" Guid="fa1bb9d9-db27-48a2-bd99-7c5661d7bdb4">
                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                                   Name="scripts" Type="string" Value="installed" KeyPath="yes" />
                    <CreateFolder />
                    <RemoveFolder Id="scriptsDirId" On="uninstall" />                                
                </Component>
            </Directory>                                              
        </DirectoryRef>
    
        <!-- ShortCut for console -->
        <DirectoryRef Id="programMenuDirId">
            <Component Id="consoleShortcut.CID" Guid="f82fd137-8342-4ad2-a481-5913043bd0ca">
                <Shortcut Id="startmenuConsole"
                          Name="$(var.mySoftware) console"
                          Description="Application Console"
                          Target="[INSTALLDIR]audiveris-console.exe"
                          WorkingDirectory="INSTALLDIR"/>
                <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
                               Name="console" Type="string" Value="installed" KeyPath="yes" />
            </Component>
        </DirectoryRef>        
    
        <!-- ShortCut for documentation -->
        <!--        <DirectoryRef Id="programMenuDirId">
        <Component Id="documentationShortcut.CID" Guid="57ae104a-30c0-44ca-8349-7d5d6cec1bd1">
        <Shortcut Id="startmenuDocumentation" 
        Name="$(var.mySoftware) documentation"
        Description="Application Documentation"
        Target="[www]index.html"
        WorkingDirectory="www"/>
        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" 
        Name="documentation" Type="string" Value="installed" KeyPath="yes" />
        </Component>
        </DirectoryRef>        -->
    
        <!-- ============ -->
        <!-- VC++ runtime -->
        <!-- ============ -->
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist.MID" 
                   SourceFile="$(var.myVC)" 
                   DiskId="1" 
                   Language="0"/>
        </DirectoryRef>            
    
        <!-- ======== -->
        <!-- Features -->
        <!-- ======== -->
        <Feature Id="Complete" Title="$(var.myProductName) features" Description="The complete package."
                 Display="expand" Level="1" ConfigurableDirectory="INSTALLDIR">
            <Feature Id="MainProgram" Title="Program" Description="The main executable" Level="1">
                <ComponentRef Id="mainExec.CID" />
                <ComponentRef Id="mainConsole.CID" />
                <ComponentRef Id="consoleShortcut.CID" />
                <ComponentRef Id="bat.CID" />
                <ComponentRef Id="programMenu.CID" />
                <ComponentRef Id="jar.CID" />
                <ComponentRef Id="gs.CID" />
                <ComponentRef Id="data.CID" />
                
                <ComponentRef Id="settings.CID" />
                <ComponentRef Id="buildProperties.CID" />
                <ComponentRef Id="loggingProperties.CID" />
                <ComponentRef Id="userActions.CID" />
                
                <ComponentRef Id="benches.CID" />
                <ComponentRef Id="print.CID" />
                <ComponentRef Id="scripts.CID" />
                <ComponentRef Id="scores.CID" />
                
                <ComponentRef Id="fonts.CID" />
        
                <ComponentRef Id="bridge.CID" />
                <ComponentRef Id="tesseract.CID" />
                <ComponentRef Id="leptonica.CID" />
        
                <ComponentGroupRef Id="lib.CID" />
                <ComponentGroupRef Id="res.CID" />
                <ComponentGroupRef Id="eval.CID" />
            </Feature>
      
            <!-- VC++ runtime (this leads to many warnings) -->
            <!-- uncomment to actually handle VC++ redist -->
            <Feature Id="VCFeature" 
                 Title="Visual C++ 8.0 Runtime" 
                 AllowAdvertise="no" 
                 Display="hidden" 
                 Level="1">
                <MergeRef Id="VCRedist.MID"/>
            </Feature>
      
            <Feature Id="OcrFeature" Title="OCR" 
                     Description="Optical Character Recognition" Level="1">
                <ComponentGroupRef Id="ocr.CID" />
            </Feature>
      
            <Feature Id="WwwFeature" Title="Documentation" 
                     Description="$(var.mySoftware) documentation" Level="1">
                <ComponentGroupRef Id="www.CID" />
                <!-- <ComponentRef Id="documentationShortcut.CID" />-->
            </Feature>
      
            <Feature Id="ExamplesFeature" Title="Examples" 
                     Description="$(var.mySoftware) examples" Level="1">
                <ComponentGroupRef Id="examples.CID" />
            </Feature>
      
            <Feature Id="PluginsFeature" Title="Plugins" 
                     Description="$(var.mySoftware) plugins" Level="1">
                <ComponentGroupRef Id="plugins.CID" />
            </Feature>
      
            <!-- All training material (lots of stuff!) -->
            <!-- uncomment for final distribution -->
            <Feature Id="TrainFeature" Title="Training material" 
                     Description="$(var.mySoftware) training material" Level="10">
                <ComponentGroupRef Id="train.CID" />
            </Feature>
      
        </Feature>
    
        <!-- For installation customization by end user -->
        <UIRef Id="WixUI_Mondo" />
        <UIRef Id="WixUI_ErrorProgressText" />
    
        <!-- Application icon -->
        <Icon Id="myIcon.exe" SourceFile="$(var.myIconSource)" />
    
    </Product>
</Wix>
