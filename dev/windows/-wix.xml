<!-- +=====================================================================+ -->
<!-- |                                                                     | -->
<!-- |                          - w i x . x m l                            | -->
<!-- |                                                                     | -->
<!-- +=====================================================================+ -->

<project name="-wix" basedir="../..">
    
    <description>
        Targets for building Audiveris Windows installer
    </description>
    
    <!-- wix task definition (with others) -->
    <taskdef 
        resource="org/apache/ant/dotnet/antlib.xml">
        <classpath>
            <pathelement location="${dotnet.jar}"/>
        </classpath>
    </taskdef>   
    
    <!-- =============================== -->
    <!--  - W X S - G E N E R A T I O N  -->
    <!-- =============================== -->
    <target name="-wxs-generation">
        
        <!-- Harvest files for common location -->
        
	<property name="heat.options" value="-nologo -gg -g1 -sfrag" />
        
        <echo message="buiding ${dev.windows.dir}/gen-common-lib.wxs" />
        <exec executable="heat">
            <arg value="dir"/>
            <arg value="${dist.dir}/lib"/>
            <arg line="${heat.options}"/>
            <arg line="-dr distDirId"/>
            <arg line="-cg lib.CID"/>
            <arg line="-var var.myDistLib"/>
            <arg line="-out ${dev.windows.dir}/gen-common-lib.wxs"/>
        </exec>
        
        <echo message="buiding ${dev.windows.dir}/gen-common-ocr.wxs" />
        <exec executable="heat">
            <arg value="dir"/>
            <arg value="${ocr.dir}"/>
            <arg line="${heat.options}"/>
            <arg line="-dr INSTALLDIR"/>
            <arg line="-cg ocr.CID"/>
            <arg line="-var var.myOcr"/>
            <arg line="-out ${dev.windows.dir}/gen-common-ocr.wxs"/>
        </exec>
        
        <echo message="buiding ${dev.windows.dir}/gen-common-res.wxs" />
        <exec executable="heat">
            <arg value="dir"/>
            <arg value="${res.dir}"/>
            <arg line="${heat.options}"/>
            <arg line="-dr INSTALLDIR"/>
            <arg line="-cg res.CID"/>
            <arg line="-var var.myRes"/>
            <arg line="-out ${dev.windows.dir}/gen-common-res.wxs"/>
        </exec>
        
        <echo message="buiding ${dev.windows.dir}/gen-common-www.wxs" />
        <exec executable="heat">
            <arg value="dir"/>
            <arg value="${www.dir}"/>
            <arg line="${heat.options}"/>
            <arg line="-dr INSTALLDIR"/>
            <arg line="-cg www.CID"/>
            <arg line="-var var.myWww"/>
            <arg line="-out ${dev.windows.dir}/gen-common-www.wxs"/>
        </exec>
        
        <!-- Harvest files for user location -->
        
        <echo message="buiding ${dev.windows.dir}/gen-user-examples.wxs" />
        <exec executable="java">
            <arg line="-jar ${tools.dir}/WixHeatUser.jar"/>
            <arg value="${examples.dir}"/>
            <arg line="-dr adProductDirId"/>
            <arg line="-cg examples.CID"/>
            <arg line="-var var.myExamples"/>
            <arg line="-out ${dev.windows.dir}/gen-user-examples.wxs"/>
        </exec>
        
        <echo message="buiding ${dev.windows.dir}/gen-user-settings.wxs" />
        <exec executable="java">
            <arg line="-jar ${tools.dir}/WixHeatUser.jar"/>
            <arg value="${settings.dir}"/>
            <arg line="-dr adProductDirId"/>
            <arg line="-cg settings.CID"/>
            <arg line="-var var.mySettings"/>
            <arg line="-out ${dev.windows.dir}/gen-user-settings.wxs"/>
        </exec>
        
        <echo message="buiding ${dev.windows.dir}/gen-user-eval.wxs" />
        <exec executable="java">
            <arg line="-jar ${tools.dir}/WixHeatUser.jar"/>
            <arg value="${eval.dir}"/>
            <arg line="-dr adProductDirId"/>
            <arg line="-cg eval.CID"/>
            <arg line="-var var.myEval"/>
            <arg line="-out ${dev.windows.dir}/gen-user-eval.wxs"/>
        </exec>

        <echo message="buiding ${dev.windows.dir}/gen-user-plugins.wxs" />
        <exec executable="java">
            <arg line="-jar ${tools.dir}/WixHeatUser.jar"/>
            <arg value="${basedir}/plugins"/>
            <arg line="-dr adProductDirId"/>
            <arg line="-cg plugins.CID"/>
            <arg line="-var var.myPlugins"/>
            <arg line="-out ${dev.windows.dir}/gen-user-plugins.wxs"/>
        </exec>
        
         <echo message="buiding ${dev.windows.dir}/gen-user-train.wxs" /> 
         <exec executable="java">
             <arg line="-jar ${tools.dir}/WixHeatUser.jar"/>
             <arg value="${train.dir}"/>
             <arg line="-dr adProductDirId"/>
             <arg line="-cg train.CID"/>
             <arg line="-var var.myTrain"/> 
             <arg line="-out ${dev.windows.dir}/gen-user-train.wxs"/>
         </exec> 
        
    </target>

    <!-- =========================================== -->
    <!--  - D O - W I N D O W S - I N S T A L L E R  -->
    <!-- =========================================== -->
    <target name="-do-windows-installer">

        <!-- Compilation -->
        <wix mode="candle"> 
            <candleParameter name="myBuildVersion" value="${spec.version}.${ant4hg.log.revision}"/>
            <candleParameter name="myCompany"      value="${Company}"/>            
            <candleParameter name="myConsole"      value="${name}-console"/>
            <candleParameter name="myDistLib"      value="${dist.dir}/lib"/>
            <candleParameter name="myEval"         value="${eval.dir}"/>
            <candleParameter name="myExamples"     value="${examples.dir}"/>
            <candleParameter name="myFullName"     value="${full.name}"/>
            <candleParameter name="myIconSource"   value="${res.dir}/icon-256.ico"/>
            <candleParameter name="myJar"          value="${dist.jar}"/>
            <candleParameter name="myMaterial"     value="${material.dir}"/>
            <candleParameter name="myOcr"          value="${ocr.dir}"/>
            <candleParameter name="myPlugins"      value="${basedir}/plugins"/>
            <candleParameter name="myRes"          value="${res.dir}"/>
            <candleParameter name="mySettings"     value="${settings.dir}"/>
            <candleParameter name="mySoftware"     value="${name}"/>
            <candleParameter name="myTrain"        value="${train.dir}"/>
            <candleParameter name="myVersion"      value="${impl.version}"/>
            <candleParameter name="myWww"          value="${www.dir}"/>
            
            <candleParameter name="myVC"           value="${env.CommonProgramFiles}/Merge Modules/Microsoft_VC90_CRT_x86.msm"/>
            
            <candleArg line="-out ${dist.dir}\"/>        
            
            <sources dir="${dev.windows.dir}">
                <include name="*.wxs"/>
            </sources>
        </wix>

        <!-- Link -->
        <wix mode="light"
             target="${dist.dir}/${full.name}.${ant4hg.log.revision}.msi">
            <lightArg line="-ext WixUIExtension" />
            <lightArg line="-dWixUILicenseRtf=${res.dir}/GPLv2.rtf" />
            <lightArg line="-sice:ICE91" />
            <sources dir="${dist.dir}/">
                <include name="*.wixobj"/>
            </sources>
        </wix>
        
    </target>
    
    <!-- ========================= -->
    <!--  - W I X - C L E A N U P  -->
    <!-- ========================= -->
    <target name="-wix-cleanup">
        
        <!-- Clean up temporary files in dist -->
        <delete verbose="${verbose}"> 
            <fileset dir="${dist.dir}" includes="*.wix*"/>
        </delete>
        
        <!-- Clean up temporary files in dev/windows -->
        <delete verbose="${verbose}"> 
            <fileset dir="${dev.windows.dir}" includes="gen-*.*"/>
        </delete>
        
    </target>

    <!-- =================================== -->
    <!--  W I N D O W S - I N S T A L L E R  -->
    <!-- =================================== -->
    <target name="windows-installer"
            depends="-hg-tip, -wxs-generation, -do-windows-installer, -wix-cleanup"
            description="Build Windows installer" />

    <!-- =============== -->
    <!--  I N S T A L L  -->
    <!-- =============== -->
    <target name="install"
	    depends="-hg-tip"
            description="Install for Windows">
        <echo message="Launching Windows installation from ${full.name}.${ant4hg.log.revision}.msi" />
        <exec executable="msiexec"
              dir="${dist.dir}">
            <arg value="/i"/>
            <arg value="${full.name}.${ant4hg.log.revision}.msi"/>
        </exec>
    </target>
    
    <!-- =================== -->
    <!--  U N I N S T A L L  -->
    <!-- =================== -->
    <target name="uninstall"
	    depends="-hg-tip"
            description="Uninstall for Windows">
        <echo message="Launching Windows uninstallation from ${full.name}.${ant4hg.log.revision}.msi" />
        <exec executable="msiexec"
              dir="${dist.dir}">
            <arg value="/x"/>
            <arg value="${full.name}.${ant4hg.log.revision}.msi"/>
        </exec>
    </target>
        
</project>
