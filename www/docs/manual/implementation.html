<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
    <HEAD>
        <!--    $Id$        -->
        <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252"/>
        <TITLE>Audiveris Implementation Manual</TITLE>
        <META NAME="AUTHOR" CONTENT="Herv&eacute; Bitteur"/>
        <META NAME="CLASSIFICATION" CONTENT="Implementation Documentation of Audiveris"/>
        <META NAME="DESCRIPTION" CONTENT="Description of Audiveris techniques"/>
                
        <!-- The following links are meant to be solved on my local PC -->
        <!-- The java.net site uses its own style sheets -->
        <LINK REL="stylesheet" TYPE="text/css" HREF="../../branding/css/tigris.css"/>
        <LINK REL="stylesheet" TYPE="text/css" HREF="../../branding/css/inst.css"/>
    </HEAD>
    
    <BODY MARGINWIDTH="0" MARGINHEIGHT="0" CLASS="app" STYLE="text-align: justify;">
	
        <H1 ALIGN=CENTER>Audiveris Implementation Manual</H1>
        
        <ADDRESS>Author
            : <A HREF="mailto:herve.bitteur@laposte.net">Herv&eacute;
            Bitteur</A></ADDRESS>
	<ADDRESS>Updated :
	    <SCRIPT TYPE="text/javascript" >
		document.write(parent.parent.getCVSDate("$Id$"));
	    </SCRIPT>
	</ADDRESS>
	
	<DIV CLASS="warningmessage">
	    <P CLASS="alert"><b>BEWARE:</b> This documentation has not yet been 
		updated for Audiveris 3.0, please consider this file as obsolete.</P>
	</DIV>
        
        <A NAME="PACKAGES">
            <H2>Packages</H2>
        </A>
        
        <P> Purpose of this implementation manual is to help any
            programmer's task : understanding the source code,
            modifying existing functions, adding new features,
            etc...</P>
        <P> Let's begin by a quick overview of the Audiveris
            decomposition in Java packages.</P>
        
        <DIV CLASS="axial">
            
            <A NAME="DRIVING">
                <H3>Driving Packages</H3>
            </A>
            
            <P> The packages that really drive Audiveris application
                are the following ones :</P>
            
            <TABLE WIDTH=100% BORDER=1>
                <TR>
                    <TH>omr.sheet</TH>
                    <TD>
                        This package is dedicated to the handling of
                        the physical music sheet, starting with the
                        image picture, and going through the sequence
                        of processing steps.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.glyph</TH>
                    <TD>
                        The glyph package deals with assemblies of
                        sections of foreground pixels that are matched
                        against predefined shapes. These glyphs can be
                        self-standing symbols (such as a clef) or
                        leaves in larger constructions (such as hote
                        heads and stem in a chord).
                    </TD>
                </TR>
                <TR>
                    <TH>omr.score</TH>
                    <TD>
                        The score package handles the logical music
                        information inferred from recognized glyphs
                        extracted from the physical sheet. The
                        internal representation of such score can be
                        stored on an external support using various
                        data formats, such as binary or XML.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.ui<BR/>omr.glyph.ui</TH>
                    <TD>
                        These two packages are used when Audiveris
                        does not run in batch mode. The former is the
                        general user interface, while the latter is
                        focused on user interface dealing with glyphs.
                    </TD>
                </TR>
            </TABLE>
            
            <A NAME="GEOMETRY">
                <H3>Geometry Packages</H3>
            </A>
            
            <P> Audiveris relies on some geometry foundation packages
		:</P>
            
            <TABLE WIDTH=100% BORDER=1>
                <TR>
                    <TH>omr.graph</TH>
                    <TD>
                        This package implements a generic directed
                        graph, made of vertices linked by directed
                        edges.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.lag</TH>
                    <TD>
                        The lag package deals with Linear Adjacency
                        Graphs, a specialized directed graph where
                        vertices are sections linked by junctions.  A
                        section is simply a connex collection of pixel
                        runs, and a run is a vector of foreground
                        pixels.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.stick</TH>
                    <TD>
                        The stick package handles sticks, that are
                        collections of sections forming either long
                        filaments (such as staff lines) or shorter and
                        straighter segments (such as bar lines, stems,
                        ledgers, etc...).
                    </TD>
                </TR>
            </TABLE>
            
            <A NAME="UTILITY">
                <H3>Utility Packages</H3>
            </A>
            
            <P> The following packages should be considered as
                implementation helpers :</P>
            
            <TABLE WIDTH=100% BORDER=1>
                <TR>
                    <TH>omr.check</TH>
                    <TD>
                        Here we define checks, organized in check
                        suites, to run series of checks to filter out
                        some candidates when looking for precise
                        entities. This filtering technique is quite
                        rough, and should perhaps be replaced by
                        proper use of specific neural networks.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.constant</TH>
                    <TD>
                        Purpose of this package is to handle
                        application logical constants in a common way,
                        from their definition in their hosting
                        classes, their potential on-line modification,
                        and their persistency on disk.  If one day
                        Audiveris migrates to NetBeans platform, the
                        bulk of this package should disappear.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.math</TH>
                    <TD>
                        This is a basic collection of mathematics
                        constructions such as lines, regressions,
                        neural networks.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.ui.treetable</TH>
                    <TD>
                        Stolen from some Sun documentation, this
                        implements a Tree/Table combination.  This
                        should be replaced by proper use of some JDNC
                        JTreeTable entity when it gets available.
                    </TD>
                </TR>
                <TR>
                    <TH>omr.util</TH>
                    <TD>
                        This package gathers various utilities that
                        are not significant enough to deserve their
                        own package.
                    </TD>
                </TR>
            </TABLE>
            
        </DIV>
        
        <A NAME="SHEET_SCORE">
            <H2>Sheet / Score</H2>
        </A>
        
        <A NAME="SHEET_VS_SCORE">
            <H3>Sheet vs. Score</H3>
        </A>
        
        <P> A <B>Sheet</B> handles the physical entities as extracted
            from the printed music sheet, while the <B>Score</B>
            handles a structuring of the inferred logical
            entities. This distinction has led to the development of
            two separate packages, namely <I>omr.sheet</I>
            and <I>omr.score</I>.</P>
	
        <P> Many entities of one package have their counterpart in the
            other package, with link from one instance to the
            other.</P>

	<P> The following table lists the corresponding
            entities in <I>omr.sheet</I> and in <I>omr.score</I>
            packages, together with the Builder class that is in
            charge of extracting these entities :</P>

	<UL>
	    <LI>For example, an instance of <B>Score</B> class is the
		counterpart of an instance of <B>Sheet</B> class. (We
		assume that several printed pages can be combined as a
		mosaic beforehand (a feature not yet fully
		implemented), so that we have to process just one
		long <B>Sheet</B>).</LI>
	
	    <LI>The next line states that a <B>System</B> in the
		<I>omr.score</I> package is the counterpart of
		a <B>SystemInfo</B> in the <I>omr.sheet</I> package,
		and that the class <B>BarsBuilder</B> is in charge of
		processing them.</LI>
        </UL>
	
        <TABLE>
            <TR>
                <TH>from omr.score package</TH>
                <TH>from omr.sheet
		    package<BR/>(model&nbsp;classes)</TH>
                <TH>from omr.sheet
		    package<BR/>(builder&nbsp;classes)</TH>
            </TR>
            <TR>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/Score.html">
                        Score</A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/Sheet.html">
                        Sheet</A></TD>
            </TR>
            <TR>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/System.html">
                        System</A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/SystemInfo.html">
                        SystemInfo</A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/BarsBuilder.html">
                        BarsBuilder</A> handles the vertical lines
                        that are recognized as bar lines</TD>
            </TR>
            <TR>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/Stave.html">
                        Stave</A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/StaveInfo.html">
                        StaveInfo</A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/LinesBuilder.html">
                        LinesBuilder</A> processes the stave areas,
                        according to the series of peaks found in the
                        horizontal projection.</TD>
            </TR>
            <TR>
                <TD></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/LineInfo.html">
                        LineInfo </A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/LinesBuilder.html">
                        LineBuilder</A> processes the horizontal area
                        that corresponds to one histogram peak, and
                        thus to one stave line.</TD>
            </TR>
            <TR>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/Measure.html">
                        Measure </A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/BarInfo.html">
                        BarInfo </A></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/BarsBuilder.html">
                        BarsBuilder</A> processes the vertical lines
                        that are recognized as bar lines.
                </TD>
            </TR>
            <TR>
                <TD></TD>
                <TD><A
                        HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/Ledger.html">
                        Ledger </A></TD>
		<TD><A
			HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/HorizontalsBuilder.html">
			HorizontalsBuilder</A> retrieves horizontal
			dashes in the given sheet. We use it for all
			horizontal glyphs (ledgers of course, but also
			legato signs or alternate endings).
		</TD>
	    </TR>
	    <TR>
		<TD></TD>
		<TD><A
			HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/Ending.html">
		    Ending </A></TD>
		<TD>see HorizontalsBuilder above
		</TD>
	    </TR>
	    <TR>
		<TD></TD>
		<TD><A
			HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/stick/Stick.html">
			Stick</A> (vertical) </TD>
		<TD><A
			HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/VerticalsBuilder.html">
			VerticalsBuilder</A> retrieves all the
			vertical sticks of all systems in the sheet at
			hand. Bars are assumed to have been already
			recognized, so this accounts for stems,
			vertical edges of endings, and parts of
			alterations (sharp, natural, flat).
		</TD>
	    </TR>
	    
	    <TR>
		<TD></TD>
		<TD> <A
			 HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/glyph/Glyph.html">
			 Glyph </A></TD>
		<TD><A
			HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/glyph/GlyphBuilder.html">
			GlyphBuilder</A> gathers non-assigned
			remaining glyphs out of a sheet.
		</TD>
	    </TR>
	</TABLE>
	
        
        <A NAME="SHEET">
            <H3>Sheet</H3>
        </A>

	<P> All the music entities are organized in Systems, read from
	    left to right. Since <B>System</B> is actually an entity
	    within the <I>omr.score</I> package, here in
	    the <I>omr.sheet</I> package we use the class <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/SystemInfo.html">
	    SystemInfo</A>.</P>

	<P> A <B>SystemInfo</B> is the repository for all physical
	    entities found within the System, such as <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/glyph/Glyph.html">
	    Glyph</A>'s, <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/BarInfo.html">
	    BarInfo</A>'s, <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/Ledger.html">
	    Ledger</A>'s, <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/sheet/StaveInfo.html">
	    StaveInfo</A>'s, and the like.</P>

	<P> So, the general schema to browse through all sheet
	    entities is usually similar to the following piece of code
	    :</P>

	<PRE>
        for (SystemInfo system : sheet.getSystems()) {
            for (Glyph glyph : system.getGlyphs()) {
	        // Do the glyph-based processing here
	    }
        }
	</PRE>

	<P> All the entities that result from the phase
	    called <B>Music Extraction</B> are made accessible through
	    the collection of <B>SystemInfo</B> instances. The phase
	    called <B>Music Recognition</B> should thus browse this
	    collection and store its results in the <B>Score</B>
	    entity.</P>
        
        <A NAME="SCORE">
            <H3>Score</H3>
        </A>

	<P> The <B>Score</B> is organized as a hierarchy of instances
	    of subclasses of <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/MusicNode.html">
	    MusicNode</A>, rooted at the Score. </P>

	<P> Each <B>MusicNode</B> is a tree node, with a container and
	    a list of children. To ease the traversal of the tree,
	    every list of children, wherever found in the tree, is a
	    list of homogeneous entities. So the Score hierarchy can
	    be listed as follows :</P>

	<PRE>
                               Score                                      
                                 O                                        
                                 |                                        
                                 |                                        
                              System                                      
                                 O                                        
                                 |                                        
                        ___________________                               
                       {StaveList, SlurList}                    Dummy     
                             O         O                                  
                             |         |                                  
                             |         |                                  
                           Stave     Slur                                 
                             O                                            
                             |                                            
        _____________________________________________                     
       {LyricList, TextList, DynamicList, MeasureList}          Dummy     
             O         O            O            O                        
             |         |            |            |                        
             |         |            |            |                        
           Lyric     Text        Dynamic      Measure                     
             O                                   O                        
             |                                   |                        
             |                _______________________________             
          Syllable           {ClefList, KeysigList, ChordList}  Dummy     
                                  O           O          O                
                                  |           |          |                
                                  |           |          |                
                                Clef       Keysig      Chord              
                                                         O                
                                                         |                
                                                         |                
                                                       Note               
	</PRE>

	<P> The beginning of figure above can be read as follows
	: </P>
	<UL>
	    <LI>A <B>Score</B> has no container, and contains
		instances of class <B>System</B> as children.</LI>
	    <UL>
		<LI>A <B>System</B> has <B>Score</B> as container and
		    exactly two children : one <B>StaveList</B> and
		    one <B>SlurList</B>.</LI>
		<OL>
		    <LI>A <B>StaveList</B> has <B>System</B> as
			container and instances of <B>Stave</B>s as
			children.</LI>
		    <UL>
			<LI>A <B>Stave</B> has <B>StaveList</B> as
			container, and exactly four children :
			one <B>LyricList</B>, one <B>TextList</B>,
			one <B>DynamicList</B> and
			one <B>MeasureList</B>.</LI>
			<LI>Etc...</LI>
		    </UL>
		    <LI>A <B>SlurList</B> has <B>System</B> as
			container and instances of <B>Slur</B>s as
			children.</LI>
		</OL>
	    </UL>
	</UL>

	<P> The hierarchical nature of this structure can be
	    conveniently used by various traversals. It is used for
	    example when the physical counterpart of each music node
	    has to be rendered in the Sheet display (see method <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/MusicNode.html#renderNode(java.awt.Graphics, omr.ui.Zoom)">
	    renderNode()</A>).</P>

	<P> Though it's currently disabled, but the source code is
	    still available, a <B>ScoreView</B> window was dedicated
	    to the painting of Score entities, using method <A
	    HREF="https://audiveris.dev.java.net/nonav/docs/api/omr/score/MusicNode.html#paintNode(java.awt.Graphics)">
	    paintNode()</A>.</P>
	    
	<P> A similar construction could be used, probably coupled
	    with Castor, to store the content of a Score using the
	    MusicXML format.</P>



	
	<BR/> <BR/>
	<HR/>
	TO BE AUGMENTED IN NEXT VERSION
	<HR/>
	<I>End of Implementation Manual</I>
	
    </BODY>
</HTML>
